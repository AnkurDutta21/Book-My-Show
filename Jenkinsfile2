pipeline {
    agent any

    tools {
        nodejs 'node23'
    }

    environment {
        AWS_REGION = 'us-east-1'
        EKS_CLUSTER_NAME = 'YOUR_CLUSTER_NAME'
    }

    stages {

        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout from Git') {
            steps {
                git branch: 'main', url: 'https://github.com/AnkurDutta21/Book-My-Show.git'
                sh 'ls -la'
            }
        }

        stage("Install NPM Dependencies") {
            steps {
                sh """
                    cd bookmyshow-app
                    npm install
                """
            }
        }

        stage('Build docker image') {
            steps {
                sh 'docker build --no-cache -t bms -f bookmyshow-app/Dockerfile bookmyshow-app'
            }
        }

        stage('Docker Build & Push') {
            steps {
                withCredentials([string(credentialsId: 'DOCKER_HUB_PASSWORD', variable: 'DOCKER_HUB_PASSWORD')]) {
                    sh 'docker login -u ankurdutta2212 -p ${DOCKER_HUB_PASSWORD}'
                }

                sh 'docker tag bms ankurdutta2212/bms:latest'
                sh 'docker push ankurdutta2212/bms:latest'
            }
        }

        /* ðŸ‘‰ NEW STAGE: FREE PORT 3000 */
        stage('Free Port 3000') {
            steps {
                sh '''
                echo "Checking if port 3000 is in use..."

                # Kill any process using port 3000
                if lsof -i:3000; then
                    echo "Port 3000 is in use - killing the process..."
                    fuser -k 3000/tcp || true
                else
                    echo "Port 3000 is free."
                fi

                # Kill any Docker container exposing port 3000
                CONTAINER_ID=$(docker ps -q --filter "publish=3000")
                if [ ! -z "$CONTAINER_ID" ]; then
                    echo "Stopping container using port 3000: $CONTAINER_ID"
                    docker stop $CONTAINER_ID || true
                    docker rm $CONTAINER_ID || true
                fi
                '''
            }
        }

        stage('Deploy to Container') {
            steps {
                sh '''
                docker rm -f bms || true
                docker run -d --name bms --restart=always -p 3000:80 ankurdutta2212/bms:latest
                docker ps -a
                '''
            }
        }

        stage('Deploy to EKS Cluster') {
            steps {
                script {
                    sh '''
                    echo "Verifying AWS credentials..."
                    aws sts get-caller-identity

                    echo "Configuring kubectl for EKS cluster..."
                    aws eks update-kubeconfig --name $EKS_CLUSTER_NAME --region $AWS_REGION

                    echo "Deploying to EKS..."
                    kubectl apply -f deployment.yml
                    kubectl apply -f service.yml

                    echo "Status..."
                    kubectl get pods
                    kubectl get svc
                    '''
                }
            }
        }
    }
}
